# 概括

OLAP，多维分析，通过多种不同的维度审视数据。

ROLAP，使用关系模型，星型模型或雪花模型构建。

MOLAP，缓解ROLAP的性能问题，借助预聚合，使用空间换取时间的形式提升查询性能。

HOLAP，ROLAP和MOLAP的集成。

Clickhouse，MPP架构，使用多主对等网络结构，基于关系模型的ROLAP方案。

查询更快，最简单有效的方法是减少数据扫描范围和数据传输时的大小。列式存储和数据压缩可实现，二者通常是伴生的，列式存储一般是数据压缩的前提。

抽象了存储部分，把存储引擎作为一层独立的接口。

多主结构，使系统架构变得更简单，天然规避了单点故障问题。

数据分片将数据进行横向切分，体现了分治思想。1个分片只能对应一个服务节点。一张本地表等同于一份数据分片，分布式表不存数据，是本地表的访问代理，能代理访问多个数据分片。有点像分库分表。

## 架构

Column和Field是最基础的映射单元。按列存储，一列数据由一个Column对象表示。如果需要操作单个具体的数值，需要Field对象，代表一个单值。

序列化和反序列化由DataType负责。

内部数据操作面向Block对象，采用流的形式。Column和Field组成数据基本映射单元，还缺少数据类型和列的名称，由Block对象实现。Block是数据表的子集，由数据对象、数据类型和列名称组成，即Column、DataType及列名称字符串。

数据表底层设计没有Table对象，使用IStorage指代数据表。

Parser负责创建AST，Interpreter负责解释AST，进一步创建查询的执行管道。与IStorage串联起整个数据查询过程。Parser将SQL解析成AST语法树。Interpreter像Service层，串联整个查询过程。

有普通函数和聚合函数两种类型函数。

集群由分片Shard组成，Shard由Replica组成。分片是逻辑上的概念，物理承载由副本承担。1个节点只能有一个分片，如果要实现1分片、1副本，需要部署2个节点。1分片1副本的配置实际只有一个物理副本。

将硬件功效最大化，重视CPU缓存失效带来的延迟。算法在前，抽象在后。函数算法选择灵活，根据数据量的不同选择不同的算法。

## 安装

```shell
# 检查是否支持SSE4.2指令集，向量化需要该特性
grep -q sse4_2 /proc/cpuinfo && echo "SSE 4.2 supported" || echo "SSE 4.2 not supported"
```

给文件目录授权

```shell
chown clickhouse.clickhouse /var/lib/clickhouse -R
```

启动服务

```shell
service clickhouse-server start
```

指定配置启动，需要切换到clickhouse用户

```shell
su clickhouse
```

批量插入数据

```shell
cat data.tsv | clickhouse-client --query "INSERT INTO data FROM TSV"
```

Clickhouse-local: 可独立运行大部分SQL，不依赖clickhouse服务端程序，可理解成clickhouse服务的单机版微内核。只能用File表引擎。数据与同机的clickhouse服务是完全隔离的，相互之间不能访问。

## 数据类型

基础类型只有数值、字符串和时间类型，没有Boolean类型。

时间类型分为DateTime、DateTime64和Date三类，目前没有时间戳类型，时间类型最高精度是秒。

复合类型，提供了数组、元组、枚举和嵌套复合类型。数组内可包含多种数据类型，但各类型必须兼容。元组支持不同的类型，但定义表字段时，需要指定明确的元素类型。元素类型和泛型的作用类似，进一步保障数据质量。枚举的key和value都不能为null，不能重复。嵌套类型本质是一种多维数组。

Nullable，辅助修饰符，类似于Optional，表示某个基础数据类型可以是Null。不能作为索引字段，慎用，会使查询和写入性能变慢。如果用Nullable修饰，会额外生成一个[Column].null.bin文件专门保存Null值，读取写入需要一倍的额外文件操作。

Domain，域名类型，分为IPv4和IPv6，本质是对整型和字符串的进一步封装。

## 数据表

数据表支持选择数据引擎，通常情况下选择默认引擎。

默认数据库实质是物理磁盘上的一个文件目录，执行语句后，会在安装路径下创建数据库文件目录以及恢复数据库的文件。

Clickhouse有临时表的概念，生命周期是会话绑定的，只支持Memory引擎，会话结束表会被销毁，不属于任何数据库。通常用于内部集群数据传播的载体。

数据分区是数据的一种纵向切分，可让查询跳过不必要的数据目录。目前只有MergeTree表引擎支持数据分区。

视图，普通试图不存储数据，只是一层简单的查询代理。物化试图支持表引擎，数据保存由表引擎决定。如果源表被写入新数据，物化视图也会同步更新，但物化视图目前不支持同步删除。物化视图实质是一张表，使用了inner前缀。

Alter操作，目前只有MergeTree、Merge和Distributed三类表引擎支持。

数据表移动的目标数据库和原始数据库必须在同一个服务节点内。

表分区可通过Detach语句卸载，分区被卸载后，物理数据并没有删除，而是被转移到当前数据表目录的detached子目录下。装载分区，将detached子目录下的某个分区重新装载回去。分区移动到了detached子目录，代表脱离了clickhouse的管理，但不会主动清理这些文件。

数据字典，以键值和属性映射的形式定义数据。可主动或被动加载到内存，支持动态更新。非常适合保存常量或经常使用的维度表数据，避免不必要的join查询。

## 表引擎

只有MergeTree支持主键索引、数据分区、数据副本和Alter操作。ReplacingMergeTree具有删除重复数据特性；SummingMergeTree会按排序键自动聚合数据；加上Replicated前缀，可以支持副本。

MergeTree写入一批数据，数据以数据片段形式写入磁盘，且不可修改。